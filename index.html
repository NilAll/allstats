<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AllStats - Gols Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0d0f12; color: #ffffff; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .match-card { background: #1a1d23; border-radius: 16px; border: 1px solid #2d3139; margin-bottom: 12px; }
        .is-green { background-color: #22c55e !important; color: #000 !important; font-weight: 900; }
        .is-red { background-color: #ef4444 !important; color: #fff !important; font-weight: 900; }
        .not-green { background-color: #ffffff !important; color: #000 !important; font-weight: 900; }
        .live-pulse { width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body class="pb-10">

    <header class="sticky top-0 bg-[#0d0f12]/95 backdrop-blur-md z-50 p-4 border-b border-gray-800 flex justify-between items-center">
        <h1 class="text-xl font-black italic uppercase">ALL<span class="text-green-500">STATS</span></h1>
        <button onclick="fetchData()" class="text-[10px] bg-gray-800 px-4 py-2 rounded-full font-bold uppercase border border-gray-700">Atualizar</button>
    </header>

    <main class="p-4">
        <div id="stats-summary" class="flex gap-2 mb-6 hidden">
            <div class="flex-1 bg-green-900/30 border border-green-600 p-3 rounded-xl text-center">
                <div class="text-[10px] uppercase font-bold text-green-500 tracking-wider">Greens (Hoje)</div>
                <div id="green-count" class="text-2xl font-black text-white">0</div>
            </div>
            <div class="flex-1 bg-red-900/30 border border-red-600 p-3 rounded-xl text-center">
                <div class="text-[10px] uppercase font-bold text-red-500 tracking-wider">Reds (Hoje)</div>
                <div id="red-count" class="text-2xl font-black text-white">0</div>
            </div>
        </div>

        <div id="status-container" class="text-center py-20">
            <div id="loading-msg" class="text-gray-500 font-bold text-xs uppercase tracking-widest animate-pulse">
                Buscando Jogos...
            </div>
            <div id="auth-btn" class="hidden">
                <p class="text-gray-400 text-sm mb-4 px-6">Valida√ß√£o de seguran√ßa necess√°ria para ver os jogos.</p>
                <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" 
                   class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-blue-900/50 transition-all inline-block uppercase text-xs tracking-wider">
                    üîì Liberar Acesso
                </a>
                <p class="text-[10px] text-gray-600 mt-4">Clique no bot√£o, depois em "Request access" e volte aqui.</p>
            </div>
        </div>

        <div id="live-area"></div>
        <div id="finished-area"></div>
        <div id="next-area"></div>
    </main>

    <script>
        const API_KEY = 'b12ef8888e5148479abd9c6632c8e00b';
        const PROXY = 'https://cors-anywhere.herokuapp.com/'; 

        // Fun√ß√£o auxiliar para pegar data local formato YYYY-MM-DD
        function getLocalDateString(offsetDays = 0) {
            const d = new Date();
            d.setDate(d.getDate() + offsetDays);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function fetchData() {
            document.getElementById('loading-msg').classList.remove('hidden');
            document.getElementById('auth-btn').classList.add('hidden');
            
            try {
                // CORRE√á√ÉO: Usando data LOCAL. Pega de Ontem (-1) at√© +6 dias.
                const start = getLocalDateString(-1);
                const end = getLocalDateString(6);
                
                // Adicionei um n√∫mero aleat√≥rio no final (&_=${Date.now()}) para evitar Cache do celular
                const res = await fetch(`${PROXY}https://api.football-data.org/v4/matches?dateFrom=${start}&dateTo=${end}&_=${Date.now()}`, {
                    headers: { 'X-Auth-Token': API_KEY }
                });

                if (res.status === 403) {
                    document.getElementById('loading-msg').classList.add('hidden');
                    document.getElementById('auth-btn').classList.remove('hidden');
                    return;
                }

                const data = await res.json();
                document.getElementById('status-container').classList.add('hidden');
                
                // Filtros
                const live = data.matches.filter(m => m.status === 'IN_PLAY' || m.status === 'PAUSED');
                const finished = data.matches.filter(m => m.status === 'FINISHED');
                const upcoming = data.matches.filter(m => m.status === 'TIMED' || m.status === 'SCHEDULED');

                renderSection('live-area', live, 'Ao Vivo', true, false);
                renderSection('finished-area', finished, 'Finalizados (Ontem/Hoje)', false, true);
                renderSection('next-area', upcoming, 'Pr√≥ximos Jogos', false, false);

                updateCounters(finished);

            } catch (e) { 
                document.getElementById('loading-msg').innerText = "Erro. Verifique internet ou Proxy.";
                console.error(e);
            }
        }

        function analyze(match) {
            // L√≥gica fixa de palpites
            const seed = match.homeTeam.id + match.awayTeam.id;
            const power = seed % 100;
            let mkt = power > 75 ? '+3.5 Gols' : power > 45 ? '+2.5 Gols' : power > 15 ? '+1.5 Gols' : '+0.5 Gols';
            if (power < 8) mkt = '- 2.5 Gols';
            return { mkt, prob: 70 + (seed % 20) };
        }

        function calculateWin(stat, h, a, isFinished) {
            const total = h + a;
            const target = parseFloat(stat.mkt.match(/[\d\.]+/)[0]);
            
            if (stat.mkt.includes('-')) {
                // Menos Gols: S√≥ √© Green se acabou E ficou abaixo
                return isFinished && total < target;
            } else {
                // Mais Gols: √â Green assim que bate a meta
                return total >= target;
            }
        }

        function updateCounters(finished) {
            let greens = 0, reds = 0;
            // Filtra para contar apenas os finalizados de HOJE no placar, para ser justo
            const todayStr = getLocalDateString(0);
            
            finished.forEach(match => {
                // Conta no placar se for de hoje. Se quiser contar ontem tamb√©m, remova o if.
                if(match.utcDate.includes(todayStr)) {
                    const stat = analyze(match);
                    const win = calculateWin(stat, match.score.fullTime.home || 0, match.score.fullTime.away || 0, true);
                    win ? greens++ : reds++;
                }
            });
            document.getElementById('green-count').innerText = greens;
            document.getElementById('red-count').innerText = reds;
            if (greens + reds > 0) document.getElementById('stats-summary').classList.remove('hidden');
        }

        function renderSection(id, list, title, isLive, isFinished) {
            const container = document.getElementById(id);
            if (!list.length) { container.innerHTML = ''; return; }

            container.innerHTML = `<h2 class="text-[10px] font-black text-gray-500 uppercase mb-3 mt-6 flex items-center gap-2 tracking-widest">
                ${isLive ? '<span class="live-pulse"></span>' : ''}${title} (${list.length})</h2>` + 
            list.map(match => {
                const stat = analyze(match);
                const h = match.score.fullTime.home || 0;
                const a = match.score.fullTime.away || 0;
                
                const win = calculateWin(stat, h, a, isFinished);
                
                let statusClass = 'not-green';
                let statusText = 'Aguardando';

                if (isFinished) {
                    statusClass = win ? 'is-green' : 'is-red';
                    statusText = win ? 'üéØ Green' : '‚ùå Red';
                } else if (win) {
                    statusClass = 'is-green';
                    statusText = 'üéØ Bateu';
                }

                const dt = new Date(match.utcDate);
                const timeStr = dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                const dateStr = dt.toLocaleDateString([], {day:'2-digit', month:'2-digit'});

                return `
                <div class="match-card p-4">
                    <div class="flex justify-between text-[9px] mb-4 font-black text-gray-500 uppercase">
                        <span>${match.area.name} - ${match.competition.name}</span>
                        <span>${isFinished ? 'FIM' : (isLive ? 'LIVE' : dateStr + ' ' + timeStr)}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex-1 space-y-4">
                            <div class="flex items-center gap-3">
                                <img src="${match.homeTeam.crest}" class="w-6 h-6 object-contain">
                                <span class="text-sm font-bold text-gray-100">${match.homeTeam.shortName}</span>
                                <span class="ml-auto font-black text-lg ${h > 0 ? 'text-green-500' : 'text-gray-500'}">${h}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <img src="${match.awayTeam.crest}" class="w-6 h-6 object-contain">
                                <span class="text-sm font-bold text-gray-100">${match.awayTeam.shortName}</span>
                                <span class="ml-auto font-black text-lg ${a > 0 ? 'text-green-500' : 'text-gray-500'}">${a}</span>
                            </div>
                        </div>
                        <div class="ml-6 ${statusClass} rounded-2xl p-3 min-w-[105px] text-center shadow-lg transition-all">
                            <div class="text-[9px] font-black uppercase leading-none">${stat.mkt}</div>
                            <div class="text-xl font-black mt-1 leading-none">${stat.prob}%</div>
                            <div class="text-[8px] font-bold mt-1.5 uppercase tracking-tighter">${statusText}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        // Inicia
        fetchData();

        // Sistema de Auto-Refresh √† Meia-Noite
        let lastDay = new Date().getDate();
        setInterval(() => {
            const currentDay = new Date().getDate();
            if (currentDay !== lastDay) {
                lastDay = currentDay;
                fetchData(); // Recarrega tudo automaticamente na virada do dia
            }
        }, 60000); // Checa a cada 1 minuto
    </script>
</body>
</html>
